var NativeNetInfo = require('react-native').NetInfo;
var EventsDispatcher = require('../../events_dispatcher');
var Util = require('../../util');

function hasOnlineConnectionState(connectionState){
  return connectionState.toLowerCase() !== "none";
}

function NetInfo(){
  EventsDispatcher.call(this);

  var self = this;
  self.online = true;

  NativeNetInfo.fetch().done(function(connectionState){
    self.online = hasOnlineConnectionState(connectionState);
  });

  NativeNetInfo.addEventListener('change', function(connectionState){
    var isNowOnline = hasOnlineConnectionState(connectionState);

    // React Native counts the switch from Wi-Fi to Cellular
    // as a state change. Return if current and previous states
    // are both online/offline
    if (self.online === isNowOnline) return;
    self.online = isNowOnline;
    if (self.online){
      self.emit("online");
    } else {
      self.emit("offline");
    }
  });
}

Util.extend(NetInfo.prototype, EventsDispatcher.prototype);

var prototype = NetInfo.prototype;

prototype.isOnline = function(){
  return self.online;
}

exports.NetInfo = NetInfo;
exports.Network = new NetInfo();